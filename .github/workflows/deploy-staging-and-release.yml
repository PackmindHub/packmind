name: Deploy Staging and Cloud Release

on:
  workflow_call:
    inputs:
      node-version:
        required: true
        type: string
        description: 'Node.js version to use'
      helm-charts-repository:
        description: 'Helm charts repository to update'
        required: true
        type: string
    secrets:
      DOCKERHUB_USERNAME:
        required: true
        description: 'Docker Hub username'
      DOCKERHUB_TOKEN:
        required: true
        description: 'Docker Hub access token'
      HELM_CHARTS_PAT:
        required: true
        description: 'Personal Access Token for Helm Charts repository'

jobs:
  update-helm-charts:
    runs-on: ${{ vars.ACTION_RUNNER_TAG || 'self-hosted' }}

    steps:
      - name: Checkout Main Repository
        uses: actions/checkout@v4

      - name: Checkout Helm Charts Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.helm-charts-repository }}
          token: ${{ secrets.HELM_CHARTS_PAT }}
          path: helm-charts

      - name: Install yq
        uses: mikefarah/yq@v4.47.2

      # ========================================================================
      # PROPRIETARY EDITION - Cloud deployments (main branch only)
      # ========================================================================
      - name: Update cloud values (main branch - proprietary)
        if: github.ref == 'refs/heads/main' && vars.PACKMIND_EDITION == 'proprietary'
        working-directory: helm-charts
        env:
          PROD_CLOUD_VALUES: "packmind-internal-values/values-prod-cloud.yaml"
          STAGING_CLOUD_VALUES: "packmind-internal-values/values-staging-cloud.yaml"
          IMAGE_TAG: "${{ github.sha }}"
        run: |
          # Update prod cloud values
          yq eval '.api.image.tag = env(IMAGE_TAG)' -i $PROD_CLOUD_VALUES
          yq eval '.frontend.image.tag = env(IMAGE_TAG)' -i $PROD_CLOUD_VALUES
          yq eval '.mcpServer.image.tag = env(IMAGE_TAG)' -i $PROD_CLOUD_VALUES

          # Update staging cloud values
          yq eval '.api.image.tag = env(IMAGE_TAG)' -i $STAGING_CLOUD_VALUES
          yq eval '.frontend.image.tag = env(IMAGE_TAG)' -i $STAGING_CLOUD_VALUES
          yq eval '.mcpServer.image.tag = env(IMAGE_TAG)' -i $STAGING_CLOUD_VALUES

      - name: Commit and Push Changes (main branch - proprietary)
        if: github.ref == 'refs/heads/main' && vars.PACKMIND_EDITION == 'proprietary'
        working-directory: helm-charts
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add packmind-internal-values/values-prod-cloud.yaml packmind-internal-values/values-staging-cloud.yaml
          git commit -m "[k8s-values] - update cloud values with commit ${{ github.sha }}"
          git push

      # ========================================================================
      # OSS EDITION - On-premise deployments
      # ========================================================================
      - name: Update staging on-prem values (main branch - oss)
        if: github.ref == 'refs/heads/main' && vars.PACKMIND_EDITION == 'oss'
        working-directory: helm-charts
        env:
          STAGING_ONPREM_VALUES: "packmind-internal-values/values-staging-onprem-oss.yaml"
          IMAGE_TAG: "${{ github.sha }}"
        run: |
          # Update staging on-premise values
          yq eval '.api.image.tag = env(IMAGE_TAG)' -i $STAGING_ONPREM_VALUES
          yq eval '.frontend.image.tag = env(IMAGE_TAG)' -i $STAGING_ONPREM_VALUES
          yq eval '.mcpServer.image.tag = env(IMAGE_TAG)' -i $STAGING_ONPREM_VALUES

      - name: Commit and Push Changes (main branch - oss)
        if: github.ref == 'refs/heads/main' && vars.PACKMIND_EDITION == 'oss'
        working-directory: helm-charts
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add packmind-internal-values/values-staging-onprem-oss.yaml
          git commit -m "[k8s-values] - update staging on-prem values with commit ${{ github.sha }}"
          git push

      - name: Get package version (release tags - oss)
        if: startsWith(github.ref, 'refs/tags/release/') && vars.PACKMIND_EDITION == 'oss'
        id: get-version
        run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

      - name: Update release on-prem values (release tags - oss)
        if: startsWith(github.ref, 'refs/tags/release/') && vars.PACKMIND_EDITION == 'oss'
        working-directory: helm-charts
        env:
          RELEASE_ONPREM_VALUES: "packmind-internal-values/values-release-onprem-oss.yaml"
          IMAGE_TAG: "${{ steps.get-version.outputs.version }}"
        run: |
          # Update release on-premise values
          yq eval '.api.image.tag = env(IMAGE_TAG)' -i $RELEASE_ONPREM_VALUES
          yq eval '.frontend.image.tag = env(IMAGE_TAG)' -i $RELEASE_ONPREM_VALUES
          yq eval '.mcpServer.image.tag = env(IMAGE_TAG)' -i $RELEASE_ONPREM_VALUES

      - name: Commit and Push Changes (release tags - oss)
        if: startsWith(github.ref, 'refs/tags/release/') && vars.PACKMIND_EDITION == 'oss'
        working-directory: helm-charts
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add packmind-internal-values/values-release-onprem-oss.yaml
          git commit -m "[k8s-values] - update release on-prem values with version v${{ steps.get-version.outputs.version }}"
          git push

      # ========================================================================
      # PROPRIETARY EDITION - On-premise release deployments
      # ========================================================================
      - name: Get package version (release tags - proprietary)
        if: startsWith(github.ref, 'refs/tags/release/') && vars.PACKMIND_EDITION == 'proprietary'
        id: get-version-proprietary
        run: echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT

      - name: Update release on-prem enterprise values (release tags - proprietary)
        if: startsWith(github.ref, 'refs/tags/release/') && vars.PACKMIND_EDITION == 'proprietary'
        working-directory: helm-charts
        env:
          RELEASE_ONPREM_ENTERPRISE_VALUES: "packmind-internal-values/values-release-onprem-enterprise.yaml"
          IMAGE_TAG: "${{ steps.get-version-proprietary.outputs.version }}"
        run: |
          # Update release on-premise enterprise values
          yq eval '.api.image.tag = env(IMAGE_TAG)' -i $RELEASE_ONPREM_ENTERPRISE_VALUES
          yq eval '.frontend.image.tag = env(IMAGE_TAG)' -i $RELEASE_ONPREM_ENTERPRISE_VALUES
          yq eval '.mcpServer.image.tag = env(IMAGE_TAG)' -i $RELEASE_ONPREM_ENTERPRISE_VALUES

      - name: Commit and Push Changes (release tags - proprietary)
        if: startsWith(github.ref, 'refs/tags/release/') && vars.PACKMIND_EDITION == 'proprietary'
        working-directory: helm-charts
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add packmind-internal-values/values-release-onprem-enterprise.yaml
          git commit -m "[k8s-values] - update release on-prem enterprise values with version v${{ steps.get-version-proprietary.outputs.version }}"
          git push
