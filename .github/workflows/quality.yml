name: Quality and Security Checks

env:
  ENTERPRISE_EDITION: proprietary
  OSS_EDITION: oss

on:
  workflow_call:
    inputs:
      node-version:
        required: true
        type: string
        description: 'Node.js version to use'
      cli-executables-artifact:
        required: true
        type: string
        description: 'CLI executables artifact name from build-proprietary'
    secrets:
      GITGUARDIAN_API_KEY:
        required: true
        description: 'API key for GitGuardian security scanning'
      SONAR_TOKEN:
        required: true
        description: 'Token for SonarCloud code quality analysis'
      PACKMIND_API_KEY:
        required: false
        description: 'API key for Packmind CLI scanning'
      PACKMIND_API_KEY_V3:
        required: false
        description: 'API key to run new packmind-cli'

jobs:
  gitguardian-scan:
    runs-on: ${{ vars.ACTION_RUNNER_TAG || 'self-hosted' }}
    name: GitGuardian scan

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: GitGuardian scan
        uses: GitGuardian/ggshield/actions/secret@v1.41.0
        env:
          GITHUB_PUSH_BEFORE_SHA: ${{ github.event.before }}
          GITHUB_PUSH_BASE_SHA: ${{ github.event.base }}
          GITHUB_PULL_BASE_SHA: ${{ github.event.pull_request.base.sha }}
          GITHUB_DEFAULT_BRANCH: ${{ github.event.repository.default_branch }}
          GITGUARDIAN_API_KEY: ${{ secrets.GITGUARDIAN_API_KEY }}

  code-quality:
    runs-on: ${{ vars.ACTION_RUNNER_TAG || 'self-hosted' }}
    strategy:
      matrix:
        node-version: ["${{ inputs.node-version }}"]

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 10 # Shallow clones should be disabled for better SonarCloud analysis
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      - run: npm ci
      - name: Generate Proprietary tsconfig
        env:
          PACKMIND_EDITION: ${{ env.ENTERPRISE_EDITION }}
        run: node scripts/select-tsconfig.mjs
      - name: Lint code (Proprietary)
        env:
          PACKMIND_EDITION: ${{ env.ENTERPRISE_EDITION }}
        run: ./node_modules/.bin/nx run-many -t lint --tuiAutoExit

      - name: Check code formatting
        run: npm run prettier:check

      - name: SonarQube Cloud Scan
        uses: SonarSource/sonarqube-scan-action@v6.0.0
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

      - name: SonarQube Quality Gate Check
        uses: SonarSource/sonarqube-quality-gate-action@v1.2.0
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  packmind:
    runs-on: ${{ vars.ACTION_RUNNER_TAG || 'self-hosted' }}
    strategy:
      matrix:
        node-version: ["${{ inputs.node-version }}"]
    name: Packmind CLI scan

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      - run: npm install -g packmind-cli
      - name: Run Packmind cli
        run: packmind-cli scan "**/*.ts,**/*.tsx" --formatters=raw --errorIfResults=true --spaces="Packmind V3"
        env:
          PACKMIND_API_KEY: ${{ secrets.PACKMIND_API_KEY }}

  packmind-cli-v3:
    runs-on: ${{ vars.ACTION_RUNNER_TAG || 'self-hosted' }}
    name: Run Packmind CLI V3
    continue-on-error: true

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download CLI executable
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.cli-executables-artifact }}
          path: ./cli-binary

      - name: Make binary executable
        run: chmod +x ./cli-binary/packmind-cli-linux-x64

      - name: Run Packmind CLI V3
        run: ./cli-binary/packmind-cli-linux-x64 lint .
        env:
          PACKMIND_API_KEY_V3: ${{ secrets.PACKMIND_API_KEY_V3 }}

  packmind-cli-v3-blocker:
    name: Run Packmind CLI V3 [Blocker version]
    runs-on: ${{ vars.ACTION_RUNNER_TAG || 'self-hosted' }}

    strategy:
      matrix:
        target:
          - apps/api
          - apps/e2e-tests
          - packages/editions
          - packages/frontend
          - packages/migrations
          - packages/skills
          - packages/spaces
          - packages/test-utils
          - packages/types
          - packages/accounts
          - packages/coding-agent
          - packages/git
          - packages/integration-tests
          - packages/linter-ast
          - packages/linter-execution
          - packages/llm
          - packages/logger
          - packages/node-utils
          - packages/recipes

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download CLI executable
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.cli-executables-artifact }}
          path: ./cli-binary

      - name: Make binary executable
        run: chmod +x ./cli-binary/packmind-cli-linux-x64

      - name: Lint ${{ matrix.target }}
        run: ./cli-binary/packmind-cli-linux-x64 lint ${{ matrix.target }}
        env:
          PACKMIND_API_KEY_V3: ${{ secrets.PACKMIND_API_KEY_V3 }}
