FROM node:22.17.1-alpine

ENV NODE_ENV=production

# Update OpenSSL and install required system dependencies
RUN apk update && \
    apk add --no-cache \
        bash \
        ca-certificates

# Use the existing node user from the base image
USER node

# Set working directory
WORKDIR /app

# Copy package files with proper ownership
COPY --chown=node:node dist/apps/mcp-server/package.json dist/apps/mcp-server/package-lock.json ./

# Install production dependencies
RUN npm install --omit=dev --ignore-scripts && npm cache clean --force

# Copy the built application with proper ownership
COPY --chown=node:node dist/apps/mcp-server/ ./

# Copy base tree-sitter WASM files to /app/ directory for runtime initialization
COPY --chown=node:node dist/apps/mcp-server/tree-sitter*.wasm ./

# Remove npm and its global node_modules to eliminate vulnerabilities
USER root
RUN rm -rf /usr/local/lib/node_modules/npm && \
    rm -f /usr/local/bin/npm /usr/local/bin/npx
USER node

# Expose port
EXPOSE 3001

# Start the application
ENTRYPOINT ["node", "main.js"]
