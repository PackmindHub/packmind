FROM node:22.17.1-alpine

ENV NODE_ENV=production

# Update OpenSSL and install required system dependencies
RUN apk update && \
    apk add --no-cache \
        openssl=3.5.4-r0 \
        bash \
        ca-certificates

# Use the existing node user from the base image
USER node

# Set working directory
WORKDIR /app

# Copy package files with proper ownership
COPY --chown=node:node dist/apps/mcp-server/package*.json ./

# Install production dependencies
RUN npm ci --omit=dev --ignore-scripts && npm cache clean --force

# Copy the built application with proper ownership
COPY --chown=node:node dist/apps/mcp-server/ ./

# Copy base tree-sitter WASM files to /app/ directory for runtime initialization
COPY --chown=node:node dist/apps/mcp-server/tree-sitter*.wasm ./

# Copy js-playground directory
COPY --chown=node:node packages/linter/js-playground ./js-playground/

ENV JS_PLAYGROUND_PATH=/app/js-playground

# Expose port
EXPOSE 3001

# Start the application
ENTRYPOINT ["node", "main.js"]
