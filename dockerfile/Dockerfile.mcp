FROM node:22.17.1-alpine

ENV NODE_ENV=production

# Update OpenSSL to fix CVE-2025-9230
RUN apk add --no-cache openssl=3.5.4-r0

# Use the existing node user from the base image
USER node

# Set working directory
WORKDIR /app

# Copy package files with proper ownership
COPY --chown=node:node dist/apps/mcp-server/package*.json ./

# Install production dependencies
RUN npm ci --omit=dev --ignore-scripts && npm cache clean --force

# Copy the built application with proper ownership
COPY --chown=node:node dist/apps/mcp-server/ ./

# Expose port
EXPOSE 3001

# Start the application
ENTRYPOINT ["node", "main.js"]
