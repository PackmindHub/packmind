{
  "name": "JavaScript Best Practices",
  "summary": "Advanced rules for writing reliable, secure, and observable JavaScript across services, CLIs, and libraries handling I/O, concurrency, and untrusted input.",
  "description": "This standard covers high-impact JavaScript language and runtime patterns: robust async control flow, deterministic resource cleanup, safe input handling, timeout/retry boundaries, structured logging, configuration hygiene, and dependency injection practices without framework assumptions.",
  "scope": "JavaScript source files",
  "rules": [
    {
      "content": "Guard every awaited operation with AbortSignal or explicit timeout; propagate the signal through internal async calls.",
      "examples": {
        "positive": "import { setTimeout as delay } from \"node:timers/promises\";\n\nasync function fetchJson(url, { signal } = {}) {\n  const controller = new AbortController();\n  const timeout = setTimeout(() => controller.abort(), 5000);\n  const combinedSignal = signal\n    ? AbortSignal.any([signal, controller.signal])\n    : controller.signal;\n\n  try {\n    const res = await fetch(url, { signal: combinedSignal });\n    if (!res.ok) throw new Error(`HTTP ${res.status}`);\n    return await res.json();\n  } finally {\n    clearTimeout(timeout);\n  }\n}\n\nawait fetchJson(\"https://example.com/api\", { signal: AbortSignal.timeout(3000) });\n",
        "negative": "async function fetchJson(url) {\n  const res = await fetch(url); // no timeout/cancellation\n  return res.json();\n}\n\nawait fetchJson(\"https://example.com/api\");\n",
        "language": "JAVASCRIPT"
      }
    },
    {
      "content": "Release file, socket, and stream resources using using/try-finally and close/destroy; never rely on garbage collection for cleanup.",
      "examples": {
        "positive": "import { open } from \"node:fs/promises\";\n\nasync function readFirstLine(path) {\n  const fh = await open(path, \"r\");\n  try {\n    const data = await fh.readFile({ encoding: \"utf8\" });\n    return data.split(\"\\n\")[0];\n  } finally {\n    await fh.close();\n  }\n}\n",
        "negative": "import { open } from \"node:fs/promises\";\n\nasync function readFirstLine(path) {\n  const fh = await open(path, \"r\");\n  const data = await fh.readFile({ encoding: \"utf8\" });\n  return data.split(\"\\n\")[0]; // file handle never closed\n}\n",
        "language": "JAVASCRIPT"
      }
    },
    {
      "content": "Prefer explicit Promise.all/Promise.allSettled for concurrent work; avoid await inside loops when iterations are independent.",
      "examples": {
        "positive": "async function loadAll(urls) {\n  const tasks = urls.map((u) => fetch(u).then((r) => r.text()));\n  const bodies = await Promise.all(tasks);\n  return bodies;\n}\n",
        "negative": "async function loadAll(urls) {\n  const bodies = [];\n  for (const u of urls) {\n    bodies.push(await (await fetch(u)).text()); // serializes independent I/O\n  }\n  return bodies;\n}\n",
        "language": "JAVASCRIPT"
      }
    },
    {
      "content": "Handle all promise rejections by awaiting, returning, or attaching catch; never fire-and-forget promises without an explicit error sink.",
      "examples": {
        "positive": "function startBackgroundJob(job, log) {\n  void job().catch((err) => log.error({ err }, \"background job failed\"));\n}\n\nstartBackgroundJob(async () => {\n  await Promise.reject(new Error(\"boom\"));\n}, console);\n",
        "negative": "function startBackgroundJob(job) {\n  job(); // unhandled rejection if job rejects\n}\n\nstartBackgroundJob(async () => {\n  await Promise.reject(new Error(\"boom\"));\n});\n",
        "language": "JAVASCRIPT"
      }
    },
    {
      "content": "Define a stable error contract by throwing custom Error subclasses with cause and codes; avoid throwing strings or mixing error shapes.",
      "examples": {
        "positive": "class DomainError extends Error {\n  constructor(message, { code, cause } = {}) {\n    super(message, { cause });\n    this.name = \"DomainError\";\n    this.code = code;\n  }\n}\n\nfunction parsePort(value) {\n  const n = Number(value);\n  if (!Number.isInteger(n) || n <= 0) {\n    throw new DomainError(\"Invalid port\", { code: \"E_BAD_PORT\" });\n  }\n  return n;\n}\n",
        "negative": "function parsePort(value) {\n  const n = Number(value);\n  if (!Number.isInteger(n) || n <= 0) {\n    throw \"Invalid port\"; // non-Error throw\n  }\n  return n;\n}\n",
        "language": "JAVASCRIPT"
      }
    },
    {
      "content": "Validate and normalize untrusted inputs at module boundaries using allowlists and type checks; avoid passing raw request/query/env values deeper.",
      "examples": {
        "positive": "function parseUserId(input) {\n  if (typeof input !== \"string\" || !/^[0-9]{1,18}$/.test(input)) {\n    throw new Error(\"Invalid userId\");\n  }\n  return input;\n}\n\nfunction handler(params) {\n  const userId = parseUserId(params.userId);\n  return { userId };\n}\n",
        "negative": "function handler(params) {\n  // params.userId used as-is throughout the codebase\n  return { userId: params.userId };\n}\n",
        "language": "JAVASCRIPT"
      }
    },
    {
      "content": "Build SQL, shell, and filesystem commands with parameterization and safe path joining; avoid string concatenation with untrusted data.",
      "examples": {
        "positive": "import path from \"node:path\";\n\nconst baseDir = \"/var/app/uploads\";\nconst safeName = \"report.txt\";\nconst fullPath = path.join(baseDir, safeName);\n\nconst query = { text: \"SELECT * FROM users WHERE id = ?\", values: [\"42\"] };\n",
        "negative": "import path from \"node:path\";\n\nconst baseDir = \"/var/app/uploads\";\nconst fullPath = baseDir + \"/\" + \"../\" + \"secrets.txt\"; // traversal risk\n\nconst userId = \"42 OR 1=1\";\nconst sql = \"SELECT * FROM users WHERE id = \" + userId; // injection\n",
        "language": "JAVASCRIPT"
      }
    },
    {
      "content": "Log events as structured objects with stable keys and correlation IDs; avoid concatenated strings and avoid logging secrets.",
      "examples": {
        "positive": "function logRequest(log, { requestId, userId, path, durationMs }) {\n  log.info({ requestId, userId, path, durationMs }, \"request completed\");\n}\n\nlogRequest(console, { requestId: \"req-123\", userId: \"u-9\", path: \"/v1/items\", durationMs: 14 });\n",
        "negative": "function logRequest(log, req) {\n  log.log(\"requestId=\" + req.requestId + \" token=\" + req.token + \" path=\" + req.path); // string concat + secret\n}\n",
        "language": "JAVASCRIPT"
      }
    },
    {
      "content": "Freeze configuration at startup by parsing env/files into a single object; avoid reading process.env ad hoc across modules.",
      "examples": {
        "positive": "function loadConfig(env) {\n  const port = Number(env.PORT ?? 3000);\n  const nodeEnv = String(env.NODE_ENV ?? \"development\");\n  return Object.freeze({ port, nodeEnv });\n}\n\nexport const config = loadConfig(process.env);\n",
        "negative": "export function getPort() {\n  return Number(process.env.PORT ?? 3000); // read env from anywhere, anytime\n}\n\nexport function isProd() {\n  return process.env.NODE_ENV === \"production\";\n}\n",
        "language": "JAVASCRIPT"
      }
    },
    {
      "content": "Inject external dependencies via parameters or constructors; avoid importing singletons directly in business logic modules.",
      "examples": {
        "positive": "export function createNotifier({ httpClient, log }) {\n  return {\n    async notify(url, payload) {\n      const res = await httpClient.post(url, payload);\n      log.info({ url, status: res.status }, \"notification sent\");\n      return res;\n    }\n  };\n}\n\nconst notifier = createNotifier({\n  httpClient: { post: async () => ({ status: 204 }) },\n  log: console\n});\n",
        "negative": "import httpClient from \"./httpClient.js\";\nimport log from \"./logger.js\";\n\nexport async function notify(url, payload) {\n  const res = await httpClient.post(url, payload); // hardwired singleton\n  log.info(\"sent \" + url);\n  return res;\n}\n",
        "language": "JAVASCRIPT"
      }
    }
  ]
}
